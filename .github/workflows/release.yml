name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org/'
    
    - name: Show package info
      run: |
        echo "Package Information:"
        node -p "const p = require('./package.json'); \`
          Name:    \${p.name}
          Version: \${p.version}
          Main:    \${p.main}
          Type:    \${p.type}
        \`"
    
    - name: Verify package.json
      run: |
        node -e "
          const pkg = require('./package.json');
          const required = ['name', 'version', 'main', 'license'];
          for (const field of required) {
            if (!pkg[field]) {
              console.error('Missing ' + field + ' in package.json');
              process.exit(1);
            }
          }
          console.log('package.json valid');
        "
    
    - name: Install ws dependency
      run: npm install ws@^8.14.2 --no-save
    
    - name: Dry run
      run: |
        echo "Dry run publish..."
        npm pack --dry-run
    
    - name: Verify module loads
      run: |
        node -e "
          import('./src/keypointJS.js').then(m => {
            console.log('ES Module loads');
            if (!m.KeypointJS) {
              console.error('KeypointJS class not exported');
              process.exit(1);
            }
            console.log('KeypointJS class available');
          }).catch(e => {
            console.error('Module load failed:', e.message);
            process.exit(1);
          })
        "
    
    - name: Publish to npm
      run: npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Verify publication
      run: |
        echo "Waiting for npm propagation..."
        sleep 3
        
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        
        echo ""
        echo "SUCCESS!"
        echo ""
        echo "$PACKAGE_NAME v$PACKAGE_VERSION published!"
        echo ""
        echo "npm: https://www.npmjs.com/package/$PACKAGE_NAME"
        echo "Docs: https://github.com/anasbex-dev/$PACKAGE_NAME"
        echo "Install: npm install $PACKAGE_NAME"
        echo ""
        echo "Thank you for using KeypointJS!"
