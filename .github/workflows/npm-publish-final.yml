name: Publish to npm

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js with npm auth
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org/'
    
    - name: Create .npmrc with token
      run: |
        echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
        echo "Created .npmrc with authentication"
    
    - name: Verify npm authentication
      run: |
        echo "Testing npm authentication..."
        npm whoami || echo "Note: npm whoami may fail with automation token"
    
    - name: Check package availability
      run: |
        echo "Checking if 'keypointjs' exists on npm..."
        if npm view keypointjs 2>/dev/null; then
          echo "ERROR: 'keypointjs' already exists on npm!"
          exit 1
        else
          echo "SUCCESS: 'keypointjs' is available!"
        fi
    
    - name: Install ws dependency
      run: |
        echo "Installing ws..."
        npm install ws@^8.14.2 --no-save
    
    - name: Dry run publish
      run: |
        echo "Dry run publish test..."
        npm pack --dry-run
    
    - name: Publish to npm
      run: |
        echo "Publishing keypointjs to npm..."
        npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Verify publication
      run: |
        echo "Waiting for npm..."
        sleep 5
        
        echo ""
        echo "========================================"
        echo "PUBLISHED SUCCESSFULLY!"
        echo "========================================"
        echo ""
        echo "Package: keypointjs"
        echo "Version: $(node -p "require('./package.json').version")"
        echo ""
        echo "npm: https://www.npmjs.com/package/keypointjs"
        echo "Docs: https://github.com/anasbex-dev/keypointjs"
        echo "Install: npm install keypointjs"
        echo ""
        echo "Thank you for using KeypointJS!"
