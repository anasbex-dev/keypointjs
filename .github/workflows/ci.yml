name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Manual trigger

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm install
    
    - name: Run BASIC tests only (skip integration & performance)
      run: |
        echo "üß™ Running basic tests..."
        # Hanya run basic.test.js
        node --test test/basic.test.js
    
    - name: Verify module structure
      run: |
        echo "üîç Verifying module structure..."
        # Cek file utama
        if [ ! -f "src/keypointJS.js" ]; then
          echo "‚ùå Missing main file: src/keypointJS.js"
          exit 1
        fi
        
        # Test import
        node -e "
          import('./src/keypointJS.js').then(m => {
            console.log('‚úÖ Main module loads');
            if (m.KeypointJS) {
              console.log('‚úÖ KeypointJS class exported');
            }
          }).catch(e => {
            console.error('‚ùå Module load failed:', e.message);
            process.exit(1);
          })
        "
    
    - name: Check package.json
      run: |
        echo "üìÑ Checking package.json..."
        node -e "
          const pkg = require('./package.json');
          const required = ['name', 'version', 'main', 'type', 'exports'];
          for (const field of required) {
            if (!pkg[field]) {
              console.error(\`‚ùå Missing \${field} in package.json\`);
              process.exit(1);
            }
          }
          console.log('‚úÖ package.json valid');
        "

  validate:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Verify exports
      run: |
        echo "üì¶ Verifying package exports..."
        node -e "
          const pkg = require('./package.json');
          const exports = pkg.exports || {};
          const requiredExports = ['.'];
          
          console.log('Package exports:', Object.keys(exports));
          
          for (const exp of requiredExports) {
            if (!exports[exp]) {
              console.error(\`‚ùå Missing required export: \${exp}\`);
              process.exit(1);
            }
          }
          console.log('‚úÖ All required exports present');
        "
